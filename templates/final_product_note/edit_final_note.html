{% extends 'css-js-links.html' %}
{% load crispy_forms_tags %}

{% block title %} Edit Final Product Note {% endblock title %}

{% block context %}
{% if request.user.is_superuser %}
  {% include 'navbar.html' %}
{% else %}
  {% include 'sale/navbar.html' %}
{% endif %}
{% endblock context %}

{% block body %}
<style>
  body {
      font-family: Arial, sans-serif;
  }

  .table-container {
      width: 90%;
      margin: 0 auto;
      padding: 20px;
      border: 1px solid #000;
      background-color: #f8f9fa;
  }

  table {
      width: 100%;
      border-collapse: collapse;
  }

  th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
  }

  th {
      background-color: #343a40;
      color: #fff;
  }

  .btn {
      margin: 5px;
  }

  .header-section, .footer-section {
      display: flex;
      justify-content: space-between;
  }

  .footer-section button {
      width: 50%;
  }

  .header-section div {
      width: 45%;
  }

  .bg-dark {
      background-color: #343a40 !important;
  }

  .text-light {
      color: #fff !important;
  }
</style>

<div class="pcoded-content">
  <div class="pcoded-inner-content">
    <div class="main-body">
      <div class="page-wrapper">
        <div class="page-body">
          <div class="row">
            <div class="col-md-12 d-flex justify-content-center">
              <div class="table-container">
                <h3 class="text-center bg-dark text-light p-3">Edit Product Note</h3>

                <form id="note-form" method="POST">
                  {% csrf_token %}
                  {{ form_note|crispy }}

                  <h5 class="mt-4">Edit Products</h5>
                  <table>
                    <thead>
                      <tr>
                        <td class="text-center">{{ form_product.product|as_crispy_field }}</td>
                        <td class="text-center">{{ form_product.quantity|as_crispy_field }}</td>
                        <td class="text-center">
                          <button id="add-product" class="btn btn-primary" type="button"><i
                        class="ti-plus me-1"></i>Product</button>
                        </td>
                      </tr>
                      <tr>
                        <th class="text-center">Product</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="product-list">
                      {% for p in existing_products %}
                      <tr data-product-id="{{ p.product.id }}">
                        <td class="text-center">{{ p.product.productname }}</td>
                        <td class="text-center">{{ p.quantity }}</td>
                        <td class="text-center">
                          <button type="button" class="btn btn-danger delete-product" data-product-id="{{ p.product.id }}"><i
                        class="ti-trash me-1"></i></button>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>

                  <button id="save-note" class="btn btn-success text-light mt-3"><i
                        class="ti-pencil me-1"></i></button>
                  <a href="/list-final-pro-note/" class="btn btn-warning text-light mt-3"><i
                        class="ti-close me-1"></i></a>
                </form>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(function () {
    let productList = [];
    let deletedProducts = [];

    // Initialize with existing products (from template)
    $('#product-list tr').each(function () {
      const productId = $(this).data('product-id');
      const quantity = $(this).find('td:nth-child(2)').text();
      productList.push({ productId, quantity });
    });

    // Add product
    $('#add-product').on('click', function () {
      const productId = $('#id_product').val();
      const productName = $('#id_product option:selected').text();
      const quantity = $('#id_quantity').val();

      if (!productId || quantity <= 0) {
        alert('Select product and valid quantity');
        return;
      }

      if (productList.some(item => item.productId == productId)) {
        alert('This product already exists.');
        return;
      }

      productList.push({ productId, quantity });

      const row = `
        <tr data-product-id="${productId}">
          <td class="text-center">${productName}</td>
          <td class="text-center">${quantity}</td>
          <td class="text-center">
            <button type="button" class="btn btn-danger delete-product" data-product-id="${productId}">Delete</button>
          </td>
        </tr>`;
      $('#product-list').append(row);
    });

    // Delete product
    $('#product-list').on('click', '.delete-product', function () {
      const productId = $(this).data('product-id');
      deletedProducts.push(productId);
      productList = productList.filter(item => item.productId != productId);
      $(this).closest('tr').remove();
    });

    // Save changes
    $('#save-note').on('click', function (e) {
      e.preventDefault();

      const formData = new FormData($('#note-form')[0]);
      formData.append('finalize', true);

      productList.forEach(item => {
        formData.append('products[]', `${item.productId}:${item.quantity}`);
      });

      deletedProducts.forEach(pid => {
        formData.append('deleted_products[]', pid);
      });

      $.ajax({
        url: $('#note-form').attr('action'),
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function (data) {
          if (data.success) {
            window.location.href = data.redirect_url;
          } else {
            alert('Failed: ' + data.errors);
          }
        },
        error: function () {
          alert('Error updating note.');
        }
      });
    });
  });
</script>
{% endblock body %}
