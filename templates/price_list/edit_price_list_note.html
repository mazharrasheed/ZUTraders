{% extends 'css-js-links.html' %}
{% load static %}

{% block title %} Edit Price List Note {% endblock title %}

{% block context %}
{% if request.user.is_superuser %}
  {% include 'navbar.html' %} 
{% else %}
  {% include 'store/navbar.html' %} 
{% endif %}
{% endblock context %}

{% block body %}
<style>
  body { font-family: Arial, sans-serif; }
  .table-container {
      width: 70%;
      margin: 0 auto;
      padding: 20px;
      border: 1px solid #000;
      background-color: #f8f9fa;
  }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #000; padding: 8px; text-align: center; }
  th { background-color: #343a40; color: #fff; }
  .btn { margin: 5px; }
  .header-section, .footer-section { display: flex; justify-content: space-between; }
  .footer-section button { width: 50%; }
  .header-section div { width: 45%; }
  .bg-dark { background-color: #343a40 !important; }
  .text-light { color: #fff !important; }
</style>

<div class="pcoded-content">
  <div class="pcoded-inner-content">
    <div class="main-body">
      <div class="page-wrapper">
        <div class="page-body">
          <div class="table-container">
            <h3 class="text-center bg-dark text-light p-3">Edit Price List Note</h3>
            <form id="price_note-form" method="POST">
              {% csrf_token %}
              <div class="header-section">
                <div>
                  <h4>Zu Traders</h4>
                  <h6>Gujranwala</h6>
                  <h6>Cell: 0300-xxxxxxx</h6>
                </div>
                <div style="margin-right:50px;width:350px">
                  <p><strong>Date:</strong> {{ note.date_created|date:"Y-m-d H:i" }}</p>
                  <div style="width: 300px !important;">{{ form_note.price_list }}</div>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <td>{{ form.product }}</td>
                    <td>{{ form.price }}</td>
                    <td>
                      <button id="add-product" class="btn btn-primary" type="button">Add Product</button>
                    </td>
                  </tr>
                  <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="product-list"></tbody>
              </table>
              
              <button id="finalize-price-note" class="btn btn-success">Update Price List Note</button>
              <a href="/price_list_detail/{{price_list_id}}" class="btn btn-warning">Cancel</a>
            </form>          
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
 $(document).ready(function () {
  // ✅ use only one array
  let productList = [];

  // Load existing products from Django context into productList
  let existingProducts = {{ existing_products|safe }};
  existingProducts.forEach((item, index) => {
    productList.push({ product: item.product__id, price: item.price });

    let row = `<tr>
                <td>${item.product__productname}</td>
                <td>${item.price}</td>
                <td><button class="delete-product btn btn-danger" data-index="${index}">Delete</button></td>
              </tr>`;
    $('#product-list').append(row);
  });

  // Add product
  $('#add-product').on('click', function () {
    const product = $('select[name="product"]').val();
    const price = $('input[name="price"]').val();

    if (!product) { alert('Please select a product.'); return; }
    if (!price || price <= 0) { alert('Please enter a valid price.'); return; }

    const existingProduct = productList.find(item => item.product == product);
    if (existingProduct) { alert('This product is already in the list.'); return; }

    productList.push({ product: product, price: price });

    const row = `<tr>
                  <td>${$('select[name="product"] option:selected').text()}</td>
                  <td>${price}</td>
                  <td><button class="delete-product btn btn-danger" data-index="${productList.length - 1}">Delete</button></td>
                 </tr>`;
    $('#product-list').append(row);
  });

  // Delete product
  $('#product-list').on('click', '.delete-product', function () {
    const index = $(this).data('index');
    productList.splice(index, 1);   // ✅ remove from array
    $(this).closest('tr').remove();

    // re-index
    $('.delete-product').each(function (i) {
      $(this).data('index', i);
    });
  });

  // Finalize submit
  $('#finalize-price-note').on('click', function (event) {
    event.preventDefault();

    const price_list = $('select[name="price_list"]').val();
    if (!price_list) { alert('Please select a Price List.'); return; }
    if (productList.length === 0) { alert('Please add at least one product.'); return; }

    const form = $('#price_note-form')[0];
    const formData = new FormData(form);

    productList.forEach(product => {
      formData.append('products[]', `${product.product}:${product.price}`);
    });

    formData.append('finalize', true);

    $.ajax({
      url: form.action,
      method: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      success: function (data) {
        if (data.success) {
          window.location.href = data.redirect_url;
        } else {
          alert('Failed to update price list note.');
        }
      },
      error: function (error) {
        alert('An error occurred. Check console.');
        console.error('Error:', error);
      }
    });
  });
});

</script>
{% endblock body %}
